Return-Path: <nvdimm+bounces-5767-lists+linux-nvdimm=lfdr.de@lists.linux.dev>
X-Original-To: lists+linux-nvdimm@lfdr.de
Delivered-To: lists+linux-nvdimm@lfdr.de
Received: from sv.mirrors.kernel.org (sv.mirrors.kernel.org [139.178.88.99])
	by mail.lfdr.de (Postfix) with ESMTPS id AF0BB691F3A
	for <lists+linux-nvdimm@lfdr.de>; Fri, 10 Feb 2023 13:43:28 +0100 (CET)
Received: from smtp.subspace.kernel.org (wormhole.subspace.kernel.org [52.25.139.140])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by sv.mirrors.kernel.org (Postfix) with ESMTPS id E82BC280C0E
	for <lists+linux-nvdimm@lfdr.de>; Fri, 10 Feb 2023 12:43:26 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id A8C1A2F45;
	Fri, 10 Feb 2023 12:43:21 +0000 (UTC)
X-Original-To: nvdimm@lists.linux.dev
Received: from frasgout.his.huawei.com (frasgout.his.huawei.com [185.176.79.56])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 4D3DCA4D
	for <nvdimm@lists.linux.dev>; Fri, 10 Feb 2023 12:43:18 +0000 (UTC)
Received: from lhrpeml500005.china.huawei.com (unknown [172.18.147.200])
	by frasgout.his.huawei.com (SkyGuard) with ESMTP id 4PCtdw0Tqzz67n8d;
	Fri, 10 Feb 2023 20:41:40 +0800 (CST)
Received: from localhost (10.202.227.76) by lhrpeml500005.china.huawei.com
 (7.191.163.240) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id 15.1.2507.17; Fri, 10 Feb
 2023 12:43:08 +0000
Date: Fri, 10 Feb 2023 12:43:07 +0000
From: Jonathan Cameron <Jonathan.Cameron@Huawei.com>
To: Brice Goglin <Brice.Goglin@inria.fr>
CC: "Verma, Vishal L" <vishal.l.verma@intel.com>, "linux-cxl@vger.kernel.org"
	<linux-cxl@vger.kernel.org>, "Williams, Dan J" <dan.j.williams@intel.com>,
	"gregory.price@memverge.com" <gregory.price@memverge.com>,
	"dave@stgolabs.net" <dave@stgolabs.net>, "nvdimm@lists.linux.dev"
	<nvdimm@lists.linux.dev>, "Weiny, Ira" <ira.weiny@intel.com>
Subject: Re: [PATCH ndctl v2 0/7] cxl: add support for listing and creating
 volatile regions
Message-ID: <20230210124307.00003be0@Huawei.com>
In-Reply-To: <34a03b27-923c-7bb0-d77a-b0fddc535160@inria.fr>
References: <20230120-vv-volatile-regions-v2-0-4ea6253000e5@intel.com>
	<e885b2a7-0405-153c-a578-b863a4e00977@inria.fr>
	<a5e4aff9f300d9b603111983165754b35c89c612.camel@intel.com>
	<34a03b27-923c-7bb0-d77a-b0fddc535160@inria.fr>
Organization: Huawei Technologies Research and Development (UK) Ltd.
X-Mailer: Claws Mail 4.1.0 (GTK 3.24.33; x86_64-w64-mingw32)
Precedence: bulk
X-Mailing-List: nvdimm@lists.linux.dev
List-Id: <nvdimm.lists.linux.dev>
List-Subscribe: <mailto:nvdimm+subscribe@lists.linux.dev>
List-Unsubscribe: <mailto:nvdimm+unsubscribe@lists.linux.dev>
MIME-Version: 1.0
Content-Type: text/plain; charset="ISO-8859-1"
Content-Transfer-Encoding: quoted-printable
X-Originating-IP: [10.202.227.76]
X-ClientProxiedBy: lhrpeml500002.china.huawei.com (7.191.160.78) To
 lhrpeml500005.china.huawei.com (7.191.163.240)
X-CFilter-Loop: Reflected

On Fri, 10 Feb 2023 11:15:44 +0100
Brice Goglin <Brice.Goglin@inria.fr> wrote:

> Le 09/02/2023 =E0 20:17, Verma, Vishal L a =E9crit=A0:
> > On Thu, 2023-02-09 at 12:04 +0100, Brice Goglin wrote: =20
> >> Hello Vishal
> >>
> >> I am trying to play with this but all my attempts failed so far. Could
> >> you provide Qemu and cxl-cli command-lines to get a volatile region
> >> enabled in a Qemu VM? =20
> > Hi Brice,
> >
> > Greg had posted his working config in another thread:
> > https://lore.kernel.org/linux-cxl/Y9sMs0FGulQSIe9t@memverge.com/
> >
> > I've also pasted below, the qemu command line generated by the run_qemu
> > script I referenced. (Note that this adds a bunch of stuff not strictly
> > needed for a minimal CXL configuration - you can certainly trim a lot
> > of that out - this is just the default setup that is generated and I
> > usually run). =20
>=20
>=20
> Hello Vishal
>=20
> Thanks a lot, things were failing because my kernel didn't have
> CONFIG_CXL_REGION_INVALIDATION_TEST=3Dy. Now I am able to create a single
> ram region, either with a single device or multiple interleaved ones.
>=20
> However I can't get multiple separate ram regions. If I boot a config
> like yours below, I get 4 ram devices. How can I create one region for
> each? Once I create the first one, others fail saying something like
> below. I tried using other decoders but it didn't help (I still need
> to read more CXL docs about decoders, why new ones appear when creating
> a region, etc).
>=20
> cxl region: collect_memdevs: no active memdevs found: decoder: decoder0.0=
 filter: mem3

Hi Brice,

QEMU emulation currently only supports single HDM decoder at each level,
so HB, Switch USP, EP (with exception of the CFMWS top level ones as shown
in the example which has two of those). We should fix that...

For now, you should be able to do it with multiple pxb-cxl instances with
appropriate CFMWS entries for each one. Which is horrible but might work
for you in the meantime. =20

>=20
> By the way, once configured in system ram, my CXL ram is merged into an
> existing "normal" NUMA node. How do I tell Qemu that a CXL region should
> be part of a new NUMA node? I assume that's what's going to happen on
> real hardware?

We don't yet have kernel code to deal with assigning a new NUMA node.
Was on the todo list in last sync call I think.

>=20
> Thanks
>=20
> Brice
>=20
>=20
>=20
> >
> >
> > $ run_qemu.sh -g --cxl --cxl-debug --rw -r none --cmdline
> > /home/vverma7/git/qemu/build/qemu-system-x86_64
> > -machine q35,accel=3Dkvm,nvdimm=3Don,cxl=3Don
> > -m 8192M,slots=3D4,maxmem=3D40964M
> > -smp 8,sockets=3D2,cores=3D2,threads=3D2
> > -enable-kvm
> > -display none
> > -nographic
> > -drive if=3Dpflash,format=3Draw,unit=3D0,file=3DOVMF_CODE.fd,readonly=
=3Don
> > -drive if=3Dpflash,format=3Draw,unit=3D1,file=3DOVMF_VARS.fd
> > -debugconfile:uefi_debug.log =20
> > -global isa-debugcon.iobase=3D0x402
> > -drive file=3Droot.img,format=3Draw,media=3Ddisk
> > -kernel ./mkosi.extra/lib/modules/6.2.0-rc6+/vmlinuz
> > -initrd mkosi.extra/boot/initramfs-6.2.0-rc2+.img
> > -append selinux=3D0 audit=3D0 console=3Dtty0 console=3DttyS0 root=3D/de=
v/sda2 ignore_loglevel rw cxl_acpi.dyndbg=3D+fplm cxl_pci.dyndbg=3D+fplm cx=
l_core.dyndbg=3D+fplm cxl_mem.dyndbg=3D+fplm cxl_pmem.dyndbg=3D+fplm cxl_po=
rt.dyndbg=3D+fplm cxl_region.dyndbg=3D+fplm cxl_test.dyndbg=3D+fplm cxl_moc=
k.dyndbg=3D+fplm cxl_mock_mem.dyndbg=3D+fplm memmap=3D2G!4G efi_fake_mem=3D=
2G@6G:0x40000
> > -device e1000,netdev=3Dnet0,mac=3D52:54:00:12:34:56
> > -netdev user,id=3Dnet0,hostfwd=3Dtcp::10022-:22
> > -object memory-backend-file,id=3Dcxl-mem0,share=3Don,mem-path=3Dcxltest=
0.raw,size=3D256M
> > -object memory-backend-file,id=3Dcxl-mem1,share=3Don,mem-path=3Dcxltest=
1.raw,size=3D256M
> > -object memory-backend-file,id=3Dcxl-mem2,share=3Don,mem-path=3Dcxltest=
2.raw,size=3D256M
> > -object memory-backend-file,id=3Dcxl-mem3,share=3Don,mem-path=3Dcxltest=
3.raw,size=3D256M
> > -object memory-backend-ram,id=3Dcxl-mem4,share=3Don,size=3D256M
> > -object memory-backend-ram,id=3Dcxl-mem5,share=3Don,size=3D256M
> > -object memory-backend-ram,id=3Dcxl-mem6,share=3Don,size=3D256M
> > -object memory-backend-ram,id=3Dcxl-mem7,share=3Don,size=3D256M
> > -object memory-backend-file,id=3Dcxl-lsa0,share=3Don,mem-path=3Dlsa0.ra=
w,size=3D1K
> > -object memory-backend-file,id=3Dcxl-lsa1,share=3Don,mem-path=3Dlsa1.ra=
w,size=3D1K
> > -object memory-backend-file,id=3Dcxl-lsa2,share=3Don,mem-path=3Dlsa2.ra=
w,size=3D1K
> > -object memory-backend-file,id=3Dcxl-lsa3,share=3Don,mem-path=3Dlsa3.ra=
w,size=3D1K
> > -device pxb-cxl,id=3Dcxl.0,bus=3Dpcie.0,bus_nr=3D53
> > -device pxb-cxl,id=3Dcxl.1,bus=3Dpcie.0,bus_nr=3D191
> > -device cxl-rp,id=3Dhb0rp0,bus=3Dcxl.0,chassis=3D0,slot=3D0,port=3D0
> > -device cxl-rp,id=3Dhb0rp1,bus=3Dcxl.0,chassis=3D0,slot=3D1,port=3D1
> > -device cxl-rp,id=3Dhb0rp2,bus=3Dcxl.0,chassis=3D0,slot=3D2,port=3D2
> > -device cxl-rp,id=3Dhb0rp3,bus=3Dcxl.0,chassis=3D0,slot=3D3,port=3D3
> > -device cxl-rp,id=3Dhb1rp0,bus=3Dcxl.1,chassis=3D0,slot=3D4,port=3D0
> > -device cxl-rp,id=3Dhb1rp1,bus=3Dcxl.1,chassis=3D0,slot=3D5,port=3D1
> > -device cxl-rp,id=3Dhb1rp2,bus=3Dcxl.1,chassis=3D0,slot=3D6,port=3D2
> > -device cxl-rp,id=3Dhb1rp3,bus=3Dcxl.1,chassis=3D0,slot=3D7,port=3D3
> > -device cxl-type3,bus=3Dhb0rp0,memdev=3Dcxl-mem0,id=3Dcxl-dev0,lsa=3Dcx=
l-lsa0
> > -device cxl-type3,bus=3Dhb0rp1,memdev=3Dcxl-mem1,id=3Dcxl-dev1,lsa=3Dcx=
l-lsa1
> > -device cxl-type3,bus=3Dhb1rp0,memdev=3Dcxl-mem2,id=3Dcxl-dev2,lsa=3Dcx=
l-lsa2
> > -device cxl-type3,bus=3Dhb1rp1,memdev=3Dcxl-mem3,id=3Dcxl-dev3,lsa=3Dcx=
l-lsa3
> > -device cxl-type3,bus=3Dhb0rp2,volatile-memdev=3Dcxl-mem4,id=3Dcxl-dev4
> > -device cxl-type3,bus=3Dhb0rp3,volatile-memdev=3Dcxl-mem5,id=3Dcxl-dev5
> > -device cxl-type3,bus=3Dhb1rp2,volatile-memdev=3Dcxl-mem6,id=3Dcxl-dev6
> > -device cxl-type3,bus=3Dhb1rp3,volatile-memdev=3Dcxl-mem7,id=3Dcxl-dev7
> > -M cxl-fmw.0.targets.0=3Dcxl.0,cxl-fmw.0.size=3D4G,cxl-fmw.0.interleave=
-granularity=3D8k,cxl-fmw.1.targets.0=3Dcxl.0,cxl-fmw.1.targets.1=3Dcxl.1,c=
xl-fmw.1.size=3D4G,cxl-fmw.1.interleave-granularity=3D8k
> > -object memory-backend-ram,id=3Dmem0,size=3D2048M
> > -numa node,nodeid=3D0,memdev=3Dmem0,
> > -numa cpu,node-id=3D0,socket-id=3D0
> > -object memory-backend-ram,id=3Dmem1,size=3D2048M
> > -numa node,nodeid=3D1,memdev=3Dmem1,
> > -numa cpu,node-id=3D1,socket-id=3D1
> > -object memory-backend-ram,id=3Dmem2,size=3D2048M
> > -numa node,nodeid=3D2,memdev=3Dmem2,
> > -object memory-backend-ram,id=3Dmem3,size=3D2048M
> > -numa node,nodeid=3D3,memdev=3Dmem3,
> > -numa node,nodeid=3D4,
> > -object memory-backend-file,id=3Dnvmem0,share=3Don,mem-path=3Dnvdimm-0,=
size=3D16384M,align=3D1G
> > -device nvdimm,memdev=3Dnvmem0,id=3Dnv0,label-size=3D2M,node=3D4
> > -numa node,nodeid=3D5,
> > -object memory-backend-file,id=3Dnvmem1,share=3Don,mem-path=3Dnvdimm-1,=
size=3D16384M,align=3D1G
> > -device nvdimm,memdev=3Dnvmem1,id=3Dnv1,label-size=3D2M,node=3D5
> > -numa dist,src=3D0,dst=3D0,val=3D10
> > -numa dist,src=3D0,dst=3D1,val=3D21
> > -numa dist,src=3D0,dst=3D2,val=3D12
> > -numa dist,src=3D0,dst=3D3,val=3D21
> > -numa dist,src=3D0,dst=3D4,val=3D17
> > -numa dist,src=3D0,dst=3D5,val=3D28
> > -numa dist,src=3D1,dst=3D1,val=3D10
> > -numa dist,src=3D1,dst=3D2,val=3D21
> > -numa dist,src=3D1,dst=3D3,val=3D12
> > -numa dist,src=3D1,dst=3D4,val=3D28
> > -numa dist,src=3D1,dst=3D5,val=3D17
> > -numa dist,src=3D2,dst=3D2,val=3D10
> > -numa dist,src=3D2,dst=3D3,val=3D21
> > -numa dist,src=3D2,dst=3D4,val=3D28
> > -numa dist,src=3D2,dst=3D5,val=3D28
> > -numa dist,src=3D3,dst=3D3,val=3D10
> > -numa dist,src=3D3,dst=3D4,val=3D28
> > -numa dist,src=3D3,dst=3D5,val=3D28
> > -numa dist,src=3D4,dst=3D4,val=3D10
> > -numa dist,src=3D4,dst=3D5,val=3D28
> > -numa dist,src=3D5,dst=3D5,val=3D10
> > =20


